//
//  amfitakeover.c
//  Chimera13
//
//  Created by CoolStar on 3/30/20.
//  Copyright Â© 2020 coolstar. All rights reserved.
//

#include "amfitakeover.h"
#include <stdio.h>

mach_port_t amfid_port;

kern_return_t mach_vm_region(vm_map_t, mach_vm_address_t *, mach_vm_size_t *, vm_region_flavor_t, vm_region_info_t, mach_msg_type_number_t *, mach_port_t *);
kern_return_t mach_vm_read_overwrite(vm_map_t target_task, mach_vm_address_t address, mach_vm_size_t size, mach_vm_address_t data, mach_vm_size_t *outsize);

uint64_t load_addr(mach_port_t port){
    kern_return_t err;
    mach_msg_type_number_t region_count = VM_REGION_BASIC_INFO_64;
    memory_object_name_t object_name = MACH_PORT_NULL;
    mach_vm_size_t first_size = 0x1000;
    mach_vm_address_t first_addr = 0x0;
    struct vm_region_basic_info_64 region = {0};
    err = mach_vm_region(port,
                         &first_addr,
                         &first_size,
                         VM_REGION_BASIC_INFO_64,
                         (vm_region_info_t)&region,
                         &region_count,
                         &object_name);
    if (err != KERN_SUCCESS){
        printf("Failed to get the region: %s\n", mach_error_string(err));
        return -1;
    }
    return first_addr;
}

uint64_t amfid_read64(uint64_t addr){
    uint64_t data;
    mach_vm_size_t sz;
    mach_vm_read_overwrite(amfid_port, addr, sizeof(uint64_t), &data, &sz);
    return data;
}

void amfid_takeover(mach_port_t port) {
    amfid_port = port;
    
    uint64_t load_address = load_addr(port);
    printf("Got load address: 0x%llx\n", load_address);
    
    uint64_t hdr = amfid_read64(load_address);
    printf("Got hdr: 0x%llx\n", hdr);
}
